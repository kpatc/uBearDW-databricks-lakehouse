{
  "name": "ubear_gold_batch",
  "description": "Pipeline batch quotidien pour enrichissement Gold layer avec SCD2 et agrégations",
  "email_notifications": {
    "on_start": [],
    "on_success": ["data-team@ubear.com"],
    "on_failure": ["data-team@ubear.com", "data-lead@ubear.com"],
    "no_alert_for_skipped_runs": false
  },
  "webhook_notifications": {},
  "timeout_seconds": 7200,
  "max_concurrent_runs": 1,
  "tasks": [
    {
      "task_key": "gold_enrichment_pipeline",
      "description": "Enrichissement complet Gold layer - Geocoding, SCD2, Dimensions, Fact tables",
      "python_wheel_task": {
        "package_name": "ubear-gold-pipeline",
        "entry_point": "run_gold_pipeline",
        "named_parameters": {
          "catalog": "ubear_catalog",
          "bronze_schema": "ubear_bronze",
          "silver_schema": "ubear_silver",
          "gold_schema": "ubear_gold"
        }
      },
      "libraries": [
        {
          "pypi": {
            "package": "geohash2==1.1"
          }
        },
        {
          "pypi": {
            "package": "h3==3.7.6"
          }
        }
      ],
      "new_cluster": {
        "spark_version": "13.3.x-scala2.12",
        "node_type_id": "Standard_DS3_v2",
        "num_workers": 4,
        "spark_conf": {
          "spark.databricks.delta.optimizeWrite.enabled": "true",
          "spark.databricks.delta.autoCompact.enabled": "true",
          "spark.sql.adaptive.enabled": "true",
          "spark.sql.adaptive.coalescePartitions.enabled": "true"
        },
        "custom_tags": {
          "project": "ubear-dw",
          "layer": "gold",
          "environment": "production"
        }
      },
      "timeout_seconds": 5400,
      "email_notifications": {},
      "notification_settings": {
        "no_alert_for_skipped_runs": false,
        "no_alert_for_canceled_runs": false,
        "alert_on_last_attempt": true
      }
    },
    {
      "task_key": "optimize_gold_tables",
      "description": "Optimisation et Z-ORDER des tables Gold après enrichissement",
      "depends_on": [
        {
          "task_key": "gold_enrichment_pipeline"
        }
      ],
      "spark_python_task": {
        "python_file": "/Workspace/Repos/ubear-dw/pipelines/gold_pipeline.py",
        "parameters": [
          "--catalog", "ubear_catalog",
          "--schema", "ubear_gold"
        ]
      },
      "libraries": [],
      "new_cluster": {
        "spark_version": "13.3.x-scala2.12",
        "node_type_id": "Standard_DS3_v2",
        "num_workers": 2,
        "spark_conf": {
          "spark.databricks.delta.optimize.maxFileSize": "134217728"
        }
      },
      "timeout_seconds": 3600,
      "email_notifications": {},
      "notification_settings": {
        "no_alert_for_skipped_runs": false,
        "no_alert_for_canceled_runs": false,
        "alert_on_last_attempt": false
      }
    },
    {
      "task_key": "generate_gold_metrics",
      "description": "Génération des métriques business et statistiques Gold layer",
      "depends_on": [
        {
          "task_key": "optimize_gold_tables"
        }
      ],
      "notebook_task": {
        "notebook_path": "/Workspace/Repos/ubear-dw/pipelines/gold_pipeline",
        "base_parameters": {
          "catalog": "ubear_catalog",
          "gold_schema": "ubear_gold"
        }
      },
      "existing_cluster_id": "${var.batch_cluster_id}",
      "timeout_seconds": 1800,
      "email_notifications": {},
      "notification_settings": {
        "no_alert_for_skipped_runs": false,
        "no_alert_for_canceled_runs": false,
        "alert_on_last_attempt": false
      }
    }
  ],
  "schedule": {
    "quartz_cron_expression": "0 0 2 * * ?",
    "timezone_id": "UTC",
    "pause_status": "UNPAUSED"
  },
  "format": "MULTI_TASK",
  "git_source": {
    "git_url": "https://github.com/kpatc/uBearDW-databricks-lakehouse",
    "git_provider": "gitHub",
    "git_branch": "main"
  },
  "max_retries": 2,
  "min_retry_interval_millis": 300000
}
